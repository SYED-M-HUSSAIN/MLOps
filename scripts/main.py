from scripts.github_client import get_repo, post_review_comment
from scripts.diff_fetcher import fetch_pr_diff
from scripts.anthropic_client import call_anthropic_api
from scripts.config import Config

def main():
    print("ğŸš€ Starting AI PR Review Process...")
    try:
        print(f"ğŸ”§ Repo: {Config.REPO_OWNER}/{Config.REPO_NAME}")
        print(f"ğŸ”¢ PR Number: {Config.PR_NUMBER}")

        # Fetch the repository and PR diff
        repo = get_repo()
        diff_text = fetch_pr_diff(repo, Config.PR_NUMBER)
        print(f"ğŸ“„ Diff length: {len(diff_text)}")

        # Call the Anthropic API for a review
        review_comment = call_anthropic_api(diff_text)
        print("ğŸ“ Review comment:\n", review_comment)

        # Echo the review to GitHub Actions logs
        print(f"::set-output name=review_comment::{review_comment}")

        if review_comment.strip():
            # Post review comment if available
            post_review_comment(repo.get_pull(Config.PR_NUMBER), review_comment)
            print("âœ… Review process completed successfully.")
        else:
            print("âš ï¸ No review comment was generated by Claude.")

    except Exception as e:
        print(f"âŒ Error during review: {e}")
